# M5StamPLCとDLightユニットで作る太陽光連動型水中モーター制御システム

M5Stack社のM5StamPLCにユニットセンサーDLightを接続して、太陽光からの照度を測定し、推定される日射量から積算日射量を計算し、積算日射量が一定量増加する度に、水中モーターをONするためにリレーを一定時間の間ONするプログラムを作成しました。

本記事では、このシステムのプログラムの主要な要素と、実装上の工夫点について解説します。

## プログラムの主要な要素

### 1. Ambientへのデータ送信
IoTデータ可視化サービス「Ambient」へ、以下の3つのデータを1分間隔（設定可）で送信しています。

*   **データ1**: 平均照度 (Lux)
    *   1分間の計測値の平均を送信します。
*   **データ2**: 積算日射量 (kWh/m^2)
    *   その日の積算エネルギー量を送信します（毎日0時にリセット）。
*   **データ3**: 積算リレー稼働時間 (秒)
    *   水中モーターが稼働した合計時間を送信します。

### 2. リレー制御（水中モーター）
M5StamPLCにはリレー出力が標準で搭載されています。
本プログラムでは、シンプルに**4つのリレー全てを同時にON/OFF**する仕様にしていますが、接続する水中モーターの台数や用途に合わせてコードを変更することが可能です。

コード内の `checkRelay()` 関数や手動操作部分（ボタンC）にある `M5StamPLC.writePlcRelay(index, state)` の記述を変更することで、個別の制御も容易です。

```cpp
// 例: リレー0と1だけをONにする場合
M5StamPLC.writePlcRelay(0, true);
M5StamPLC.writePlcRelay(1, true);
// M5StamPLC.writePlcRelay(2, true); // コメントアウトすれば動作しない
// M5StamPLC.writePlcRelay(3, true);
```

### 3. 積算日射量の計算方法
照度センサー（DLight）から得られる値は「照度（Lux）」ですが、農業やエネルギー管理でよく使われる「日射量（W/m^2）」に簡易的に変換して計算しています。

**計算式（簡易換算）:**
一般的な太陽光の換算係数として `1 Lux ≒ 0.0079 W/m^2` を使用しています。

```cpp
// 定数定義
const double LUX_TO_KW_M2 = 0.0079 / 1000.0; // W/m2 を kW/m2 に変換

// 計算処理（1秒ごとに実行）
double kw_m2 = currentData.lux * LUX_TO_KW_M2;
accumulatedEnergy += kw_m2 * (MEASURE_INTERVAL / 3600000.0); // kWhに変換して積算
```
これにより、瞬間的な明るさではなく「どれだけの光エネルギーを受け取ったか」を基準にモーターを制御できます。

---

## 設定と操作機能

本システムでは、PCに繋がなくても本体のボタンだけで設定を変更・保存できるようにしています。設定値は不揮発性メモリ（Preferences/NVS）に保存されるため、**電源を切っても設定が保持され、再起動時は保存された値が初期値として読み込まれます。**

### ボタンA：積算日射量の閾値設定
「積算日射量がどれくらい増えたらモーターを動かすか」という閾値を設定します。
ボタンAを押すたびに、プリセットされた値（例: 0.01, 0.03, ... 5.0 kWh/m^2）が循環して切り替わります。

*   **機能**: ポンプを動かす頻度を調整します。値を小さくすると頻繁に動き、大きくするとあまり動かなくなります。
*   **保存**: 変更されたインデックスは `prefs.putInt("thIdx", thresholdIndex)` で即座に保存されます。

### ボタンB：リレーON持続時間設定
一度条件を満たしたときに「何秒間モーターを回すか」を設定します。
ボタンBを押すたびに、時間（例: 5秒, 10秒, ... 60秒）が切り替わります。

*   **機能**: 一回の給水量を調整します。
*   **保存**: 変更されたインデックスは `prefs.putInt("durIdx", durationIndex)` で保存されます。

### ボタンC：マニュアル操作
センサーの値に関係なく、強制的にリレーをON/OFFできます。
メンテナンスや動作確認時に使用します。ボタンCを押すたびにONとOFFが反転します。

---

## 通信とハードウェア制御の工夫

### WiFi接続の安定化
WiFi接続時は、接続試行状況を画面にアニメーション表示します。
また、接続がうまくいかない場合のリトライ処理を組み込んでいます。
1.  一定回数接続に失敗すると、一度 `WiFi.disconnect()` を実行してリセット。
2.  それでも繋がらない場合は `ESP.restart()` で再起動をかけ、自動復帰を試みます。

### I2C通信のノイズ対策 (DLight)
現場運用では、モーター等のノイズによりI2C通信が一瞬不安定になり、センサー値が誤って `0` となる現象が発生することがあります。
これを防ぐため、値が `0` だった場合は即座に採用せず、数回再読み込み（リトライ）を行う処理を入れています。

```cpp
float val = dlight.getLUX();
if (val == 0) {
    for(int i=0; i<3; i++) {
        delay(50); // 少し待機
        val = dlight.getLUX(); // 再取得
        if (val > 0) break; // 正常値が取れたらループを抜ける
    }
}
```
この簡単な処理を入れるだけで、突発的な0落ちによる誤動作（積算値の計算ミスなど）を大幅に減らすことができます。
