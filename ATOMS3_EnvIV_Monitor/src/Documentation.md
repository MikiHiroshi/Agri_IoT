# 【M5Stack】ATOMS3とUnit EnvIVで温湿度・気圧ロガーを作る（Ambient連携・グラフ表示）

ATOMS3と環境センサーユニット（Unit EnvIV）を使って、温度・湿度・気圧を同時に測定し、クラウド（Ambient）へ送信しつつ、3つのグラフを重ねてリアルタイム表示できるデバイスを作りました。

この記事では、その機能と実装したArduinoスケッチのポイントを解説します。

## 作ったもの

ATOMS3にUnit EnvIV（SHT40 + BMP280搭載）を接続し、以下の機能を持たせました。

1.  **3項目同時測定**: 1秒ごとに温度・湿度・気圧を取得。
2.  **画面表示**:
    *   **上部**: 各測定値を色分けして表示（温度:白, 湿度:黄, 気圧:水色）。
    *   **下部**: 過去90分間の3項目の推移を、1つのグラフエリアに重ねて表示。
3.  **高機能グラフ**:
    *   **オートスケール**: 3項目それぞれに最適なスケール（最大値・最小値）を動的に計算。
    *   **スマートな目盛り**: 中間等の数値が「.5」を含む場合は小数点表示、整数の場合は整数表示に自動切り替え。
    *   **多軸ラベル**: 3項目のラベルが重ならないよう、左端に少しずつずらして積層表示。
4.  **クラウド送信**: 1分間の「平均値」を計算し、IoTデータ可視化サービス「Ambient」へ送信。
5.  **堅牢なWiFi接続**: 接続切れ時の自動リトライ・自動再起動機能を搭載。

## 用意するもの

*   M5Stack ATOMS3
*   M5Stack Unit EnvIV (温度・湿度・気圧センサ)
*   Groveケーブル (Unit EnvIVに付属)

## ソースコードの解説

作成したスケッチのポイントを解説します。

### 1. センサーの初期化とデータ取得

Unit EnvIVはSHT40（温湿度）とBMP280（気圧）を搭載しています。`M5UnitENV` ライブラリを使って制御します。

```cpp
#include <M5UnitENV.h>

SHT4X sht4;
BMP280 bmp;

void setup() {
    // ...
    // SHT40 (温湿度) 初期化
    if (!sht4.begin(&Wire, SHT40_I2C_ADDR_44, 2, 1, 400000U)) { /* エラー処理 */ }
    sht4.setPrecision(SHT4X_HIGH_PRECISION);

    // BMP280 (気圧) 初期化
    if (!bmp.begin(&Wire, BMP280_I2C_ADDR, 2, 1, 400000U)) { /* エラー処理 */ }
    // ...
}
```

### 2. 3軸オートスケールグラフの実装

温度（20℃付近）、湿度（50%付近）、気圧（1000hPa付近）という桁の違うデータを1つのグラフに描画するため、それぞれに独立したスケール計算を行っています。

`getMinMax` 関数で、履歴データからそれぞれの最小値・最大値を「きりの良い数値（5刻みや10刻み）」になるように計算しています。

```cpp
void getMinMax(float* data, int type, float& outMin, float& outMax) {
    // ... (データから最大・最小を検索)

    if (type == 0) { // 温度: 区切り5, 最小幅5
        outMin = floor(dMin / 5.0) * 5.0;
        outMax = ceil(dMax / 5.0) * 5.0;
        if (outMax - outMin < 5.0) outMax = outMin + 5.0;
    }
    // ... (湿度、気圧も同様に専用のルールで計算)
}
```

### 3. 目盛りラベルの工夫（積層表示と小数点）

左側のY軸ラベルは、3つの指標（白・黄・水色）をすべて表示するため、表示位置を数ピクセルずつずらして（Stackさせて）描画しています。

また、中間値のラベルは「22.5」のような数値の時は小数点で、「23.0」のような時は整数で表示するようにフォーマットを調整しています。

```cpp
// 中間値のラベル表示ロジック
float midVal = (plotMax + plotMin) / 2.0;
String midStr;
// 整数と一致するか判定
if (midVal == (int)midVal) {
    midStr = String((int)midVal); // "23"
} else {
    midStr = String(midVal, 1);   // "22.5"
}

// 描画位置の微調整（視覚的なバランス調整）
M5.Display.drawString(midStr, graphMinX - 2, graphTopY + (graphHeight / 2) + labelOffsetY - 7);
```

### 4. 堅牢なWiFi接続

長時間運用を前提に、WiFi接続が切れた場合の復帰処理を強化しています。

*   **リトライ**: 接続が切れたら即座に再接続を試行。
*   **強制再起動**: 何度リトライしても繋がらない場合は、WiFiモジュールの不調を疑い `ESP.restart()` でマイコンごとリセットします。

```cpp
void loop() {
    // 常に接続監視
    if (WiFi.status() != WL_CONNECTED) {
        WiFiConnect(); // 再接続プロセスへ
        return; 
    }
    // ...
}
```

## まとめ

ATOMS3の128x128という小さな画面ですが、工夫次第で3つの環境データをグラフィカルかつ詳細にモニタリングできるデバイスになりました。色分けとオートスケールにより、パッと見て現在の状況と傾向がつかめるのが特徴です。
